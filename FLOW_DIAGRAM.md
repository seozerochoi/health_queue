# 인바디 OCR 기능 플로우 다이어그램

## 전체 시스템 아키텍처

```
┌─────────────┐         ┌─────────────┐         ┌──────────────┐
│   사용자    │ ◄─────► │  Frontend   │ ◄─────► │   Backend    │
│  (모바일)   │         │   React     │         │    Django    │
└─────────────┘         └─────────────┘         └──────┬───────┘
                                                        │
                                                        ▼
                                                ┌──────────────┐
                                                │     AWS      │
                                                │ Rekognition  │
                                                └──────────────┘
```

## 사용자 플로우

### 1. 이미지 선택 단계
```
[마이페이지]
     │
     ▼
[인바디 사진 촬영 버튼 클릭]
     │
     ▼
┌─────────────────┐
│ 1. 카메라 촬영  │
│ 2. 갤러리 선택  │
└────────┬────────┘
         │
         ▼
   [이미지 선택]
```

### 2. 이미지 조정 단계
```
[선택된 이미지]
     │
     ▼
┌──────────────────┐
│ 프리뷰 화면 표시 │
│                  │
│ - 크롭 영역 조정 │
│ - 회전 (90도)    │
└────────┬─────────┘
         │
         ▼
   [분석하기 버튼]
```

### 3. OCR 처리 단계
```
[이미지 전처리]
     │
     ├─ 크롭 적용
     ├─ 회전 적용
     ├─ 대비 증가
     └─ 밝기 조정
     │
     ▼
[base64 인코딩]
     │
     ▼
[서버로 전송]
     │
     ▼
[AWS Rekognition]
     │
     ▼
[텍스트 추출]
     │
     ▼
[데이터 파싱]
```

### 4. 결과 표시 단계
```
[파싱된 데이터]
     │
     ▼
┌─────────────────────┐
│ 결과 화면           │
│                     │
│ - 체중: 70.5 kg     │
│ - 골격근량: 32.1 kg │
│ - 체지방률: 17.5 %  │
│ - BMI: 23.4         │
│ - 인바디점수: 85    │
└──────────┬──────────┘
           │
           ▼
    [저장하기 버튼]
           │
           ▼
    [프로필 업데이트]
```

## Backend API 플로우

### API 엔드포인트: POST /api/users/inbody/upload/

```
[클라이언트 요청]
     │
     ├─ Authorization: Bearer {token}
     ├─ Content-Type: application/json
     └─ Body: { image: "base64...", auto_save: false }
     │
     ▼
[인증 확인]
     │
     ▼
[이미지 디코딩]
     │
     ├─ base64 디코딩
     └─ bytes 변환
     │
     ▼
[OCR 서비스 호출]
     │
     ▼
┌──────────────────────────────┐
│ InBodyOCRService             │
│                              │
│ 1. detect_text()             │
│    └─ AWS Rekognition API    │
│                              │
│ 2. parse_inbody_data()       │
│    ├─ 키워드 매칭            │
│    └─ 숫자 추출              │
└──────────────┬───────────────┘
               │
               ▼
         [파싱 결과]
               │
               ▼
      [auto_save=true?]
          │        │
         Yes       No
          │        │
          ▼        ▼
     [프로필 저장]  [데이터만 반환]
          │        │
          └────┬───┘
               │
               ▼
        [JSON 응답]
```

## OCR 데이터 파싱 로직

```
[텍스트 감지 결과]
     │
     ▼
[LINE 타입 필터링]
     │
     ▼
┌─────────────────────────────────────┐
│ 키워드 매핑                         │
│                                     │
│ "체중" → weight_kg                  │
│ "골격근량" → skeletal_muscle_mass_kg│
│ "체지방량" → body_fat_mass_kg       │
│ "체지방률" → body_fat_percentage    │
│ "BMI" → bmi                         │
│ "인바디점수" → inbody_score         │
└──────────────┬──────────────────────┘
               │
               ▼
     [각 라인 순회]
               │
               ▼
     [키워드 포함 여부 확인]
               │
               ├─ 키워드 발견
               │     │
               │     ▼
               │  [같은 라인에서 숫자 추출]
               │     │
               │     ├─ 성공 → 저장
               │     └─ 실패
               │           │
               │           ▼
               │     [다음 라인에서 숫자 추출]
               │           │
               │           └─ 성공 → 저장
               │
               └─ 다음 라인
```

## 클라이언트 이미지 전처리

```
[원본 이미지]
     │
     ▼
┌─────────────────┐
│ Canvas 생성     │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 크롭 적용       │
│ - 사용자 지정   │
│   영역만 추출   │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 회전 적용       │
│ - 0/90/180/270도│
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 이미지 보정     │
│ - 대비 1.2배    │
│ - 밝기 +10      │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ JPEG 압축       │
│ - 품질 95%      │
└────────┬────────┘
         │
         ▼
[base64 인코딩]
```

## 에러 처리 플로우

```
[OCR 처리]
     │
     ├─ 성공
     │    └─► [결과 표시]
     │
     └─ 실패
          │
          ├─ AWS 인증 오류
          │    └─► "AWS 자격증명을 확인하세요"
          │
          ├─ 텍스트 감지 실패
          │    └─► "이미지에서 텍스트를 찾을 수 없습니다"
          │
          ├─ 데이터 추출 실패
          │    └─► "인바디 데이터를 추출하지 못했습니다"
          │
          └─ 네트워크 오류
               └─► "서버 연결에 실패했습니다"
```

## 데이터 모델 매핑

```
┌─────────────────────────┐
│ UserProfile Model       │
├─────────────────────────┤
│ weight_kg               │ ◄── OCR 추출
│ skeletal_muscle_mass_kg │ ◄── OCR 추출
│ body_fat_mass_kg        │ ◄── OCR 추출
│ body_fat_percentage     │ ◄── OCR 추출
│ bmi                     │ ◄── OCR 추출
│ inbody_score            │ ◄── OCR 추출
│ segment_right_arm_kg    │ ◄── OCR 추출 (선택)
│ segment_left_arm_kg     │ ◄── OCR 추출 (선택)
│ segment_trunk_kg        │ ◄── OCR 추출 (선택)
│ segment_right_leg_kg    │ ◄── OCR 추출 (선택)
│ segment_left_leg_kg     │ ◄── OCR 추출 (선택)
└─────────────────────────┘
```

## 보안 플로우

```
[사용자 요청]
     │
     ▼
[JWT 토큰 확인]
     │
     ├─ 유효 → 계속
     │
     └─ 무효
          │
          ├─ 토큰 갱신 시도
          │    │
          │    ├─ 성공 → 계속
          │    └─ 실패 → 로그아웃
          │
          └─ 갱신 토큰 없음 → 로그아웃
```

## 성능 고려사항

### 이미지 최적화
```
원본 이미지 (예: 3-5MB)
     │
     ▼
크롭 + 회전 (필요한 영역만)
     │
     ▼
압축 (JPEG 95% 품질)
     │
     ▼
최적화된 이미지 (예: 500KB-1MB)
     │
     ▼
base64 인코딩 (+33% 크기)
     │
     ▼
전송 (예: 650KB-1.3MB)
```

### API 응답 시간
```
이미지 업로드: ~1-2초
AWS Rekognition: ~2-3초
데이터 파싱: ~0.1초
────────────────────────
총 예상 시간: ~3-5초
```
